<!DOCTYPE html>

<html>

    <head>

        <script src="jquery.min.js"></script>
        <script src='dat.gui.min.js'></script>
        <script src="three.min.js"></script>
        <script src="trackball.js"></script>
        <script src="OculusRiftEffect.js"></script>
        <script src="webrift.js"></script>

        <script>

            "use strict";

            var scene,
                camera,
                renderer,
                particles,
                material,
                worker,
                updateQueue = [],
                waiting = false,
                trackball,
                controls,
                gui,
                generation = 0,
                canvas,
                zoom = {current: 1.0, target: 1.5},
                particleSystem,
                webrift,
                dummy,
                OReffect;


            $(function() {

                controls = new Controls();
                controls.writeHash();
                gui = new dat.GUI();
                gui.close();
                gui.addColor(controls, 'foreground').name('Foreground').onChange(function(value) {
                    particleSystem.material.color.r = value[0]/255;
                    particleSystem.material.color.g = value[1]/255;
                    particleSystem.material.color.b = value[2]/255;
                    controls.writeHash();
                });
                gui.add(controls, 'resolution', 0, 1).name("Resolution").onFinishChange(function(value) {
                    renderer.setSize(window.innerWidth * controls.resolution, window.innerHeight * controls.resolution);
                    controls.writeHash();
                });
                gui.add(controls, 'size', 0.01, 1).name("Particle Size").step(0.01).onChange(function() {
                    controls.writeHash();
                });
                gui.add(controls, 'opacity', 0, 1).name("Particle Opacity").onChange(function() {
                    controls.writeHash();
                });
                gui.add(controls, 'speed', 0, 2500).name("Simulation Speed").step(1).onChange(function() {
                    controls.writeHash();
                });
                gui.add(controls, 'simsize', 8, 128).name("Simulation Size").step(1).onFinishChange(function(value) {
                    initializeField();
                    controls.writeHash();
                });
                gui.add(controls, 'lonely', 0, 26).name("Lonely").step(1).onFinishChange(function() {
                    initializeField();
                    controls.writeHash();
                });
                gui.add(controls, 'crowded', 0, 26).name("Crowded").step(1).onFinishChange(function() {
                    initializeField();
                    controls.writeHash();
                });
                gui.add(controls, 'reset').name("Reset Simulation");
                gui.generation = gui.add(controls, 'generation').name("Generation 0");

                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
                camera.position.set(0,0,4);
                camera.lookAt(new THREE.Vector3(0,0,0));

                material = new THREE.ParticleBasicMaterial({map: THREE.ImageUtils.loadTexture("particle.png"),
                                                            color: 0xffd100,
                                                            size: 8, 
                                                            opacity: 0.01, 
                                                            transparent: true, 
                                                            blending: THREE.AdditiveBlending,
                                                            depthTest: false});

                canvas = document.getElementById('conway');
                canvas.onselectstart = function () { return false; }
                renderer = new THREE.WebGLRenderer({antialias: false, canvas: canvas});
                renderer.setSize(window.innerWidth * controls.resolution, window.innerHeight * controls.resolution);

                var HMD = {
                    hResolution: 1280,
                    vResolution: 800,
                    hScreenSize: 0.14976,
                    vScreenSize: 0.0936,
                    interpupillaryDistance: 0.064,
                    lensSeparationDistance: 0.064,
                    eyeToScreenDistance: 0.041,
                    distortionK : [1.0, 0.22, 0.24, 0.0],
                    chromaAbParameter: [ 0.996, -0.004, 1.014, 0.0]
                };
                OReffect = new THREE.OculusRiftEffect(renderer, {HMD: HMD, worldFactor: 1});
                OReffect.setSize(1280, 800);

                webrift = new Webrift("ws://localhost:1981");

                initializeField();

                window.addEventListener('DOMMouseScroll', onMouseWheel, false);
                window.addEventListener('mousewheel', onMouseWheel, false);

                animate();
            });


            var Controls = function() {
                var hash = {};
                try {
                    var hash = decodeURIComponent(window.location.hash);
                    hash = JSON.parse(hash.replace("#",""));
                }
                catch (err) {
                    console.warn("Failed to parse json in window.location.hash");
                }
                this.foreground = hash.foreground || [0, 128, 255];
                this.resolution = hash.resolution || 1.0;
                this.opacity = hash.opacity || 1.0;
                this.size = hash.size || 0.01;
                this.speed = hash.speed || 1;
                this.simsize = hash.simsize || 32;
                this.lonely = hash.lonely || 4;
                this.crowded = hash.crowded || 14;
                this.reset = initializeField;
                this.generation = function() {};

                this.writeHash = function() {
                    var hash = { foreground: this.foreground, 
                                 resolution: this.resolution, 
                                 opacity: this.opacity,
                                 size: this.size,
                                 speed: this.speed,
                                 lonely: this.lonely,
                                 crowded: this.crowded,
                                 simsize: this.simsize }
                    window.location.hash = JSON.stringify(hash);
                }

            }


            function initializeField() {

                scene = new THREE.Scene();

                dummy = new THREE.Object3D();
                dummy.position.set(0,1.5,0);
                scene.add(dummy);

                particles = new THREE.BufferGeometry();
                particles.dynamic = true;
                particles.attributes = {
                    position : {
                        itemSize: 3,
                        array: new Float32Array(controls.simsize*controls.simsize*controls.simsize*3),
                        numItems: controls.simsize*controls.simsize*controls.simsize*3
                    }
                }
                var positions = particles.attributes.position.array;
                for (var p = 0; p < positions.length*3; p++) {
                    positions[p] = 1e38;
                }

                particles.computeBoundingSphere();

                particleSystem = new THREE.ParticleSystem(particles, material);
                particleSystem.material.color.r = controls.foreground[0]/255;
                particleSystem.material.color.g = controls.foreground[1]/255;
                particleSystem.material.color.b = controls.foreground[2]/255;
                particleSystem.sortParticles = false;

                dummy.add(particleSystem);

                if (worker != undefined) {
                    worker.terminate();
                }

                generation = 0;
                worker = new Worker("worker.js");
                worker.addEventListener('message', queue);
                worker.postMessage({cmd: 'initialize', size: controls.simsize, lonely: controls.lonely, crowded: controls.crowded});
                worker.postMessage({cmd: 'next'});
                updateQueue = [];


                var geometry = new THREE.CubeGeometry(8, 8 ,8);
                geometry.computeTangents();
                var texture = new THREE.ImageUtils.loadTexture( 'grid.png' );
                var normal = new THREE.ImageUtils.loadTexture( 'normalmap.png' );
                var mat = new THREE.MeshPhongMaterial({color: 0x00ff00, side: THREE.DoubleSide, map: texture, normalMap: normal, shininess: 50, metal: false, specular: 0x555555});
                var mesh = new THREE.Mesh(geometry, mat);
                mesh.position.set(0, 4, 0);
                scene.add(mesh);

                var light = new THREE.PointLight(0x0088ff);
                light.position.set(0.125,0,0);
                dummy.add(light);

                trackball = new Trackball(canvas, dummy);
            }


            function queue(e) {
                updateQueue = updateQueue.concat(e.data);
                generation += 1;
                gui.generation.name("Generation " + generation);
                waiting = false;
            }


            function animate() {
                requestAnimationFrame(animate);
                updateField();
                if (!trackball.mouseDown) {
                    dummy.rotation.x += 0.001;
                    dummy.rotation.y += 0.002;
                }
                zoom.current += 0.25 * (zoom.target - zoom.current);
                camera.position.set(0,1.62,zoom.current);
                camera.quaternion.set(webrift.x, webrift.y, webrift.z, webrift.w);
                OReffect.render(scene, camera);
            }


            function updateField() {
                material.size = controls.size;
                material.opacity = controls.opacity;
                var positions = particles.attributes.position.array;
                var count = Math.min(controls.speed*4, updateQueue.length);
                var u = updateQueue.splice(0, count);
                for (var i = 0; i < u.length; i+=4) {
                    var x  = u[i + 0];
                    var y  = u[i + 1];
                    var z  = u[i + 2];
                    var on = u[i + 3];
                    var pindex = (x*controls.simsize*controls.simsize + y*controls.simsize + z) * 3;
                    var scale = 0.5/controls.simsize;
                    if (on) {
                        positions[pindex + 0] = scale*(x-controls.simsize/2);
                        positions[pindex + 1] = scale*(y-controls.simsize/2);
                        positions[pindex + 2] = scale*(z-controls.simsize/2);
                    }
                    else {
                        positions[pindex + 0] = 1e38;
                        positions[pindex + 1] = 1e38;
                        positions[pindex + 2] = 1e38;
                    }
                }
                if(updateQueue.length < 10000 && !waiting) {
                    worker.postMessage({cmd: 'next'})
                    waiting = true;
                }
                particles.attributes.position.needsUpdate = true;
            }


            function onMouseWheel(e) {
                var delta = 0;
                if(e.wheelDelta) { delta = e.wheelDelta };
                if(e.detail) { delta = -e.detail };
                if (delta < 0) { 
                    zoom.target *= 1.1; 
                } else { 
                    zoom.target *= 0.9; 
                }
                zoom.target = Math.min(zoom.target, 3.110);
                zoom.target = Math.max(zoom.target, 0.783);
            }


        </script>

        <style>

            html, body {
                margin: 0px;
                padding: 0px;
                width:100%;
                height:100%;
            }

            canvas {
                cursor: pointer;
            }

            #help {
                text-align: right;
                color: white;
                font-size: 12px;
                position: fixed;
                font-family: sans-serif;
                bottom: 8px;
                right: 8px;
            }

            #webrift-help {
                font-size: 16px;
                position: fixed;
                font-family: sans-serif;
                bottom: 8px;
                left: 8px;
                color: red;
            }

            #webrift-help a:link {
                color: orange;
            }

        </style>

    </head>

    <body>

        <canvas style="width:100%;height:100%;position:fixed;top:0;left:0" id='conway'></canvas>
        <div id="webrift-help">Install <a href="http://wwwtyro.github.io/webrift">webrift</a> to use your oculus rift.</div>
        <div id="help">
            Controls in upper right.<br>
            Left click and drag to rotate.<br>
            Scroll wheel to zoom in and out.<br>
        </div>

    </body>

</html>

<script>

